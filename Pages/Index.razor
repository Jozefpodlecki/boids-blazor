@page "/"
@using Blazor.Extensions
@using Blazor.Extensions.Canvas.Canvas2D
@using FlockingSimulator.Components
@using FlockingSimulator.Components.Icons

@inject ILogger<Index> Logger;
@inject IJSRuntime JsRuntime;

<BECanvas @ref="_canvasReference"></BECanvas>
<BottomPanel
    IsDebugEnabled="_isDebugEnabled"
    IsRunning="_isRunning"
    OnDebug="OnDebug"
    OnScreenshot="OnScreenshot"
    OnRun="OnRun"
    OnSettings="OnSettings"  />

@if (_isConfigurationVisible)
{
    <Configuration Options="_options" OptionsChanged="OptionsChanged" OnClose="CloseModal" />
}

@code
{
    private BECanvasComponent _canvasReference = default!;
    private Canvas2DContext _outputCanvasContext = default!;
    private BoidsSimulatorOptions _options = default!;
    private BoidsSimulator _simulator = default!;
    private bool _isConfigurationVisible = false;
    private bool _isDebugEnabled = false;
    private bool _isRunning = true;
    private double _lastFrameTimestamp;
    private bool _isHidden;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) {
            return;
        }

        Logger.LogDebug("First Render");
        var dotNetReference = DotNetObjectReference.Create(this);
        _outputCanvasContext = await _canvasReference.CreateCanvas2DAsync();

        await JsRuntime.InvokeVoidAsync("registerEvents", dotNetReference);
        await JsRuntime.InvokeVoidAsync("startAnimationFrame", dotNetReference);
    }

    private void SetupSimulator(double width, double height) {
        _options ??= new BoidsSimulatorOptions();

        _options.Width = (int)width;
        _options.Height = (int)height;
        
        _simulator = new BoidsSimulator(Logger, _options);
    }

    private async ValueTask SetCanvasResolutionAsync(double width, double height)
    {
        var parameters = new Dictionary<string, object?>
        {
            { nameof(BECanvasComponent.Width), (long)width },
            { nameof(BECanvasComponent.Height), (long)height }
        };
        await _canvasReference.SetParametersAsync(ParameterView.FromDictionary(parameters));
    }

    [JSInvokable]
    public async ValueTask OnResize(double width, double height)
    {
        Logger.LogDebug("OnResize: {} {}", width, height);
        await SetCanvasResolutionAsync(width, height);
        SetupSimulator(width, height);
    }

    [JSInvokable]
    public async ValueTask OnVisibilityChange(bool isHidden)
    {
        Logger.LogDebug("OnVisibilityChange: {}", isHidden);
        _isHidden = isHidden;
    }

    private void OptionsChanged(BoidsSimulatorOptions options)
    {
        Logger.LogDebug("OptionsChanged: {}", options);

        if(_options.Fps != options.Fps)
        {
            Logger.LogDebug("Fps Changed: {}", options);
        }

        var recreateSimulator = false;

        if(_options.MaxSpeed != options.MaxSpeed
            || _options.Count != options.Count
            || _options.SeparationDistance != options.SeparationDistance
            || _options.PerceptionRadius != options.PerceptionRadius)
        {
            recreateSimulator = true;
        }

        _options.Fps = options.Fps;
        _options.FrameThresholdMilliseconds = options.FrameThresholdMilliseconds;
        _options.SeparationDistance = options.SeparationDistance;
        _options.PerceptionRadius = options.PerceptionRadius;
        _options.Count = options.Count;
        _options.MaxSpeed = options.MaxSpeed;

        if(recreateSimulator)
        {
            _simulator = new BoidsSimulator(Logger, _options);
        }
    }

    [JSInvokable]
    public async ValueTask OnFrame(double timestamp)
    {
        if(!_isRunning) {
            return;
        }

        if(_simulator == null) {
            return;
        }

        if(_isHidden) {
            return;
        }

        if (timestamp - _lastFrameTimestamp < _options.FrameThresholdMilliseconds)
        {
            Logger.LogDebug("{} {} {}", timestamp, _lastFrameTimestamp, timestamp - _lastFrameTimestamp);
            return;
        }

        _lastFrameTimestamp = timestamp;

        await _outputCanvasContext.ClearRectAsync(0, 0, _options.Width, _options.Height);
        await _simulator.UpdateAndRenderAsync(_outputCanvasContext, _isDebugEnabled);
    }

    private void OnSettings()
    {
        Logger.LogDebug("Settings Popup");
        _isConfigurationVisible = true;
    }

    private void OnScreenshot()
    {

    }

    private void OnRun()
    {
        _isRunning = !_isRunning;
    }

    private void OnDebug()
    {
        Logger.LogDebug("Debug Toggle: {}", _isDebugEnabled);
        _isDebugEnabled  = !_isDebugEnabled;
    }

    private void CloseModal()
    {
        _isConfigurationVisible = false;
    }

    private void OnOptionsChange(BoidsSimulatorOptions updatedOptions)
    {
        _options = updatedOptions;
    }
}